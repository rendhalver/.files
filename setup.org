#+TITLE: Computamatron setup

Setup and maintain software on my various laptops

* install
  :PROPERTIES:
  :header-args: :tangle yes
  :END:

** Set our OS type

   Set our OS type so we can use it to download binaries

   #+BEGIN_SRC sh :tangle (when (eq system-type 'gnu/linux) "yes")
     OS_TYPE='linux-amd64'
   #+END_SRC

   #+BEGIN_SRC sh :tangle (when (eq system-type 'darwin) "yes")
     OS_TYPE='darwin-amd64'
   #+END_SRC

** install jq

   Install jq so we can use it to parse json data

   #+BEGIN_SRC sh
     if ! [ -x "$(command -v jq)" ]; then
   #+END_SRC

   #+BEGIN_SRC sh :tangle (when (eq system-type 'darwin) "yes")
       brew install jq
   #+END_SRC

   #+BEGIN_SRC sh :tangle (when (eq system-type 'gnu/linux) "yes")
       sudo apt install jq
   #+END_SRC

   #+BEGIN_SRC sh
     fi
   #+END_SRC

** Global base dependencies

   Define the list of applications we need for pretty much everything on all platforms

   #+BEGIN_SRC sh
     GLOBAL_DEP_LIST='automake autoconf libtool unzip curl'
   #+END_SRC

** base dependencies

   Define the list of applications we need for each platform

   #+BEGIN_SRC sh :tangle (when (eq system-type 'gnu/linux) "yes")
     DEP_LIST="$GLOBAL_DEP_LIST libreadline-dev libncurses-dev libssl-dev libyaml-dev libxslt-dev libffi-dev unixodbc-dev"
   #+END_SRC

   #+BEGIN_SRC sh :tangle (when (eq system-type 'darwin) "yes")
     DEP_LIST="$GLOBAL_DEP_LIST wget readline ncurses openssl libyaml libxslt libffi unixodbc"
   #+END_SRC

** Install dependencies

   Install the dependencies we defined earlier

   #+BEGIN_SRC sh
     for app in $DEP_LIST; do
   #+END_SRC

   #+BEGIN_SRC sh :tangle (when (eq system-type 'gnu/linux) "yes")
       sudo apt install $app
   #+END_SRC

   #+BEGIN_SRC sh :tangle (when (eq system-type 'darwin) "yes")
       if [ "$( brew info --json=v1 $app | jq .[0].installed[].version )" == "" ]; then
         echo "installing $app"
         brew install $app
       else
         echo "$app installed"
       fi
   #+END_SRC

   #+BEGIN_SRC sh
     done
   #+END_SRC

** Install Brew Cask Applications

   Install the apps we using regularly on MacOS

   #+BEGIN_SRC sh :tangle (when (eq system-type 'darwin) "yes")
     CASK_LIST="1password-beta alfred arq balenaetcher flux firefox-nightly firefox-beta firefox-developer-edition gitify gpg-suite-nightly iterm2-nightly keepassxc libreoffice private-internet-access razer-synapse riot setapp slack-beta spotify standard-notes tresorit virtualbox virtualbox-extension-pack xquartz zoomus"
     for app in $CASK_LIST; do
       if [ ! "$( brew cask list | grep $app )" ]; then
         echo "$app not installed"
         echo "installing $app"
         brew cask install $app
       fi
     done
   #+END_SRC

** Install Keybase

   Install Keybase

   #+BEGIN_SRC sh :tangle (when (eq system-type 'darwin) "yes")
     if [ $(which keybase) ]; then
       echo "keybase already installed"
     else
       brew cask install keybase
     fi
   #+END_SRC

   #+BEGIN_SRC sh :tangle (when (eq system-type 'gnu/linux) "yes")
     if [ $(which keybase) ]; then
       echo "keybase already installed"
     else
       echo "installing keybase"
       curl --remote-name https://prerelease.keybase.io/keybase_amd64.deb
       sudo dpkg -i keybase_amd64.deb
       sudo apt-get install -f
       run_keybase
     fi
   #+END_SRC

** Install Docker

   Make sure we have Docker installed

   #+BEGIN_SRC sh :tangle (when (eq system-type 'darwin) "yes")
     if [ "$( brew cask list | grep 'docker-edge' )" ]; then
       echo "docker already installed"
     else
       brew cask install docker-edge
     fi
   #+END_SRC

   #+BEGIN_SRC sh :tangle (when (eq system-type 'gnu/linux) "yes")
     if [ -e /etc/apt/sources.list.d/docker.list ]; then
       echo "docker repo already setup"
     else
       echo "installing docker"
       sudo apt-get remove docker docker-engine docker.io containerd runc
       curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
       echo "deb [arch=amd64] https://download.docker.com/linux/debian stretch stable" > sudo cat - > /apt/sources.list.d/docker.list
       sudo apt install docker-ce docker-ce-cli containerd.io
       sudo usermod -aG docker $USER
     fi
   #+END_SRC

** Install asdf

   Install asdf and the plugins we would like

   #+BEGIN_SRC sh
     ASDF_DIR=$HOME/.asdf
     if [ -e $ASDF_DIR ]; then
       echo "Updating $ASDF_DIR"
       asdf update
     else
       echo "Installing ASDF"
       git clone https://github.com/asdf-vm/asdf.git $ASDF_DIR
       cd $ASDF_DIR
       git checkout "$(git describe --abbrev=0 --tags)"
     fi
     ASDF_PLUGINS='ruby'
     for plugin in $ASDF_PLUGINS; do
       if [ -e $ASDF_DIR/plugins/$plugin ]; then
         echo "asdf $plugin plugin already installed"
         asdf plugin-update $plugin
       else
         echo "installing asdf $plugin plugin"
         asdf plugin-add $plugin
       fi
     done
   #+END_SRC

** Install Kind

   Make sure Kind is installed so we can run a local Kubernetes cluster

   #+BEGIN_SRC sh
     KIND_VERSION='v0.5.1'
     if [ $( which kind ) ]; then
         INSTALLED_KIND=$( kind version )
     else
         INSTALLED_KIND=''
     fi

     if [ "$INSTALLED_KIND" == "$KIND_VERSION" ]; then
       echo "kind $KIND_VERSION already installed"
     else
       echo "installing kind version $KIND_VERSION"
       curl -Lo /tmp/kind-${KIND_VERSION} https://github.com/kubernetes-sigs/kind/releases/download/${KIND_VERSION}/kind-${OS_TYPE}
       chmod +x /tmp/kind-${KIND_VERSION}
       mv /tmp/kind-${KIND_VERSION} /usr/local/bin/kind
     fi
   #+END_SRC
